---
title: "プロキシサーバに苦しめられた話"
date: 2023-06-11T10:45:28+09:00
---

## 注意
あんまりインフラに詳しくない大学院生が書いてます．
なるべく誤りのないようにしますが，
本記事は僕の日記という側面が強いです．
間違ってても許してください．

## 経緯

アルバイトで，ある研究室にGitBucketを導入することになった．
その研究室にはすでにIaaSの環境が整っており，自由に利用することができた．
利用予定のサーバのメモリが若干足りていなかったので，増設することになった．
メモリを増設したところ，なんかプロキシサーバが動かなくなった．

## プロキシサーバの動作環境と発生した問題

IaaSに仮想マシンを立て，その上にdockerコンテナを置いてプロキシサーバを立てていた．
メモリを増設した後，dockerコンテナ内部から外部へのネット接続が一切できなくなった．
たとえば，以下のコマンドが動かない．

```shell
curl google.com
```
(`ping`が入ってなかったので`curl`叩いてます)

dockerコンテナの内部から外部へ繋げないので，プロキシサーバとして機能できなくなっていたようである．

## 問題へのアプローチ

とりあえず以下を試してみた．
1. dockerコンテナの再起動
2. 新たなdockerコンテナの作成
3. 仮装マシンの再起動
4. サーバ本体の再起動

ここに書いた内容以外のアプローチもしたが，直らない．
アルバイトは出来高に応じて支払われるので，この時点で僕の時給は多分1000円くらいになってた．
GitBucket用のサーバ導入してデータ突っ込むだけの高コスパバイトだと思ってたのに，なぜ．．．

前述した1-4のアプローチにより，おそらく仮想マシンかサーバそのものに問題があると予想．
新たに仮想マシンを立て，dockerコンテナの中で最小構成のプロキシサーバを構築してみた．
結果，プロキシサーバとして利用できることを確認．
仮想マシンを立て直せばおそらくプロキシサーバを復活させられるだろうと安堵した．

## 解決方法
やったことは以下の通り
1. 新たに仮想マシンを立ち上げる．
2. 仮想マシン内にdockerコンテナを作成し，プロキシサーバを立てる．
3. ssl証明書発行する．
4. プロキシサーバのipアドレスを固定する．
5. 以前までのプロキシサーバを指していたグローバルipアドレスを，新たに立てたプロキシサーバに張り替える．

色々試行錯誤の末，なんとか解決できた．
ipアドレス云々の部分でだいぶ躓き，時間を浪費した．
ssl証明書とかは，研究室のドキュメントにやり方が載ってたのでかなり参考にした．

## 所感
メモリの増設程度で，仮想マシンが動かなくなることあるんだなという思い．
ipアドレスとかネットワーク周りの知識が身についた気もする．

